{{ define "head" }}
{{ if eq .Type "evento" }}
{{/* Dublin Core — proceedings */}}
<meta name="DC.title" content="{{ .Title }}{{ with .Params.subtitle }}: {{ . }}{{ end }}">
<meta name="DC.type" content="proceedings">
<meta name="DC.format" content="text/html">
<meta name="DC.language" content="pt-BR">
<meta name="DC.date" content="{{ dateFormat "2006" .Date }}">
<meta name="DC.identifier" content="{{ .Permalink }}">
{{ with .Params.event_isbn -}}
<meta name="DC.identifier" content="ISBN {{ . }}">
{{ end -}}
{{ with .Params.editors -}}
<meta name="DC.creator" content="{{ . }}">
{{ end -}}
{{ with .Params.event_publisher -}}
<meta name="DC.publisher" content="{{ . }}">
{{ end -}}
{{ with .Params.description -}}
<meta name="DC.description" content="{{ . | plainify | truncate 500 }}">
{{ end -}}
<meta name="DC.rights" content="https://creativecommons.org/licenses/by-nc-nd/4.0/">
{{ with .Params.event_location -}}
<meta name="DC.coverage" content="{{ . }}">
{{ end -}}
{{ with .Params.article_count -}}
<meta name="DCTERMS.extent" content="{{ . }} artigos">
{{ end -}}

{{/* Open Graph — proceedings */}}
<meta property="og:title" content="{{ .Title }}{{ with .Params.subtitle }}: {{ . }}{{ end }}">
<meta property="og:type" content="book">
<meta property="og:url" content="{{ .Permalink }}">
{{ with .Params.description -}}
<meta property="og:description" content="{{ . | plainify | truncate 200 }}">
{{ end -}}
<meta property="og:site_name" content="{{ .Site.Title }}">

{{/* Twitter Cards */}}
<meta name="twitter:title" content="{{ .Title }}{{ with .Params.subtitle }}: {{ . }}{{ end }}">
{{ with .Params.description -}}
<meta name="twitter:description" content="{{ . | plainify | truncate 200 }}">
{{ end -}}
{{ end }}
{{ end }}

{{ define "main" }}
<nav class="breadcrumb">
  <a href="{{ "/" | relURL }}">início</a>
  {{ if .Parent }}
    {{ if ne .Parent.RelPermalink "/" }}
    &rsaquo; <a href="{{ .Parent.RelPermalink }}">{{ .Parent.Title | lower }}</a>
    {{ end }}
  {{ end }}
  &rsaquo; <span>{{ .Title | lower }}</span>
</nav>

{{ if .Sections }}
  {{/* Âmbito level: list events */}}
  <h1 class="ambito-title">{{ .Title }}</h1>

  <div class="sort-toggle">
    <button class="sort-btn active" data-sort="date">cronológico</button>
    <button class="sort-btn" data-sort="state">por estado</button>
  </div>

  <div class="event-list" id="event-list">
  {{ range .Sections }}
    <a href="{{ .RelPermalink }}" class="event-card" data-date="{{ .Date.Format "2006" }}" data-state="{{ .Params.event_state | default "" }}" data-state-name="{{ .Params.event_state_name | default "" }}">
      {{ with .Resources.GetMatch "*.png" }}
      <img src="{{ .RelPermalink }}" alt="" class="event-cover">
      {{ end }}
      <div class="event-card-info">
        <h2>{{ .Title }}</h2>
        {{ with .Params.subtitle }}<p class="event-subtitle">{{ . }}</p>{{ end }}
        {{ with .Params.event_location }}<span class="location">{{ . }}</span>{{ end }}
        {{ with .Params.article_count }}<span class="count">{{ . }} artigos</span>{{ end }}
      </div>
    </a>
  {{ end }}
  </div>

  <script>
  (function() {
    var list = document.getElementById('event-list');
    var btns = document.querySelectorAll('.sort-btn');
    btns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        btns.forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        sortEvents(btn.dataset.sort);
      });
    });
    function sortEvents(mode) {
      // Remove state headings
      list.querySelectorAll('.state-heading').forEach(function(h) { h.remove(); });
      var cards = Array.from(list.querySelectorAll('.event-card'));
      if (mode === 'date') {
        cards.sort(function(a, b) { return b.dataset.date.localeCompare(a.dataset.date); });
        cards.forEach(function(c) { list.appendChild(c); });
      } else {
        cards.sort(function(a, b) {
          var sa = a.dataset.stateName || 'ZZZ', sb = b.dataset.stateName || 'ZZZ';
          if (sa !== sb) return sa.localeCompare(sb);
          return b.dataset.date.localeCompare(a.dataset.date);
        });
        var current = '';
        cards.forEach(function(c) {
          var st = c.dataset.stateName || '';
          if (st && st !== current) {
            current = st;
            var h = document.createElement('h2');
            h.className = 'state-heading section-heading';
            h.textContent = st;
            list.appendChild(h);
          }
          list.appendChild(c);
        });
      }
    }
  })();
  </script>
{{ else }}
  {{/* Event level: list articles with cover */}}
  <div class="event-header">
    {{ with .Resources.GetMatch "*.png" }}
    <img src="{{ .RelPermalink }}" alt="" class="event-cover-large">
    {{ end }}
    <div class="event-header-info">
      <h1>{{ .Title }}</h1>
      {{ with .Params.subtitle }}<p class="subtitle">{{ . }}</p>{{ end }}
      {{ with .Params.event_location }}<p class="meta">{{ . }}{{ with $.Params.event_publisher }} &mdash; {{ . }}{{ end }}</p>{{ end }}
      {{ with .Params.editors }}<p class="meta">Org.: {{ . }}</p>{{ end }}
      {{ with .Params.description }}<p class="meta ficha">{{ . }}</p>{{ end }}
      {{ with .Params.article_count }}<p class="meta"><strong>{{ . }} artigos</strong></p>{{ end }}
      {{ with .Params.volume_pdf }}
      <div class="volume-pdf">
        <a href="#" class="volume-pdf-btn">PDF da edição completa</a>
      </div>
      {{ end }}
    </div>
  </div>

  {{/* COinS — proceedings (volume) */}}
  <span class="Z3988" title="ctx_ver=Z39.88-2004&amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Abook&amp;rft.genre=proceeding&amp;rfr_id=info%3Asid%2Fanais.docomomobrasil.com&amp;rft.btitle={{ (printf "%s%s" .Title (cond (ne (.Params.subtitle | default "") "") (printf ": %s" .Params.subtitle) "")) | urlquery }}&amp;rft.date={{ dateFormat "2006" .Date }}{{ with .Params.event_isbn }}&amp;rft.isbn={{ . | urlquery }}{{ end }}{{ with .Params.event_publisher }}&amp;rft.pub={{ . | urlquery }}{{ end }}{{ with .Params.event_location }}&amp;rft.place={{ . | urlquery }}{{ end }}"></span>

  <div class="article-list">
  {{ $currentSection := "" }}
  {{ range sort .Pages "File.Path" }}
    {{ $sec := .Params.section_title | default "Sem seção" }}
    {{ if ne $sec $currentSection }}
      {{ $currentSection = $sec }}
      <h2 class="section-heading">{{ $sec }}</h2>
    {{ end }}
    <article class="article-item">
      <h3><a href="{{ .RelPermalink }}">{{ .Title }}{{ with .Params.subtitle }}: {{ . }}{{ end }}</a></h3>
      <p class="authors">
        {{ range $i, $au := .Params.authors }}{{ if $i }}; {{ end }}{{ $au.givenname }} {{ $au.familyname }}{{ end }}
      </p>
      {{ if .Params.zenodo_pdf_url }}
      <a href="{{ .Params.zenodo_pdf_url }}" class="btn-pdf-sm">PDF</a>
      {{ else if .Params.pdf_file }}
      <span class="btn-pdf-sm btn-pdf-sm--pending">PDF</span>
      {{ end }}
      {{/* COinS — artigo individual */}}
      <span class="Z3988" title="ctx_ver=Z39.88-2004&amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Abook&amp;rft.genre=conference&amp;rfr_id=info%3Asid%2Fanais.docomomobrasil.com&amp;rft.atitle={{ (printf "%s%s" .Title (cond (ne (.Params.subtitle | default "") "") (printf ": %s" .Params.subtitle) "")) | urlquery }}&amp;rft.btitle={{ $.Title | urlquery }}&amp;rft.date={{ dateFormat "2006" .Date }}{{ range .Params.authors }}&amp;rft.au={{ (printf "%s, %s" .familyname .givenname) | urlquery }}{{ end }}{{ with .Params.doi }}&amp;rft_id=info%3Adoi%2F{{ . | urlquery }}{{ end }}{{ with .Params.event_isbn }}&amp;rft.isbn={{ . | urlquery }}{{ end }}{{ with .Params.pages }}&amp;rft.pages={{ . | urlquery }}{{ end }}{{ with $.Params.event_publisher }}&amp;rft.pub={{ . | urlquery }}{{ end }}{{ with .Params.event_city }}&amp;rft.place={{ . | urlquery }}{{ end }}"></span>
    </article>
  {{ end }}
  </div>
{{ end }}
{{ end }}
